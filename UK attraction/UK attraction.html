<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>UK Attractions Map (Layer Version)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- 外部资源引入 -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
      /* 设定页面和地图全屏 & 禁止滚动 */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden; /* 去掉滚动条 */
}
        /* 基础地图样式 */
        #map {
            width: 100%;
            height: 100vh;
        }

        /* 控制面板样式 */
        #panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-family: sans-serif;
            font-size: 14px;
            z-index: 10;
        }

        /* 图例样式 */
        #legend h4 {
            margin: 5px 0 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-color-box {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 50%;
        }

        /* 游客数量面板样式 */
        #regionalChartPanel {
            position: absolute;
            bottom: 80px;
            left: 20px;
            width: 500px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        /* 滑块样式 */
        #yearSlider {
            width: 50%;
            background-color: #ddd;
            height: 8px;
            border-radius: 4px;
            margin: 10px 0;
        }
        #yearSlider::-webkit-slider-thumb {
            background-color: #00B8A9;
        }

        /* 图表容器 */
        #chartContainer {
            width: 100%;
            height: 250px;
        }
        
/*

#regionalChart {
    transition: opacity 0.3s ease; /* 添加过渡效果 */
/* } */
    </style>
</head>
<body>
    <!-- 地图容器 -->
    <div id="map"></div>
    
    <!-- 左侧控制面板 -->
    <div id="panel">
        
        
    <!-- 地区筛选框 -->
<div>
  <label id="regionlabel">Region: All</label><br>
  <select id="regionfilter">
    <option value="All">All</option>
    <option value="North East">North East</option>
    <option value="North West">North West</option>
    <option value="Yorkshire and The Humber">Yorkshire and The Humber</option>
    <option value="East Midlands">East Midlands</option>
    <option value="West Midlands">West Midlands</option>
    <option value="East of England">East of England</option>
    <option value="London">London</option>
    <option value="South East">South East</option>
    <option value="South West">South West</option>
  </select>
</div>
<!--        类别筛选框-->
        <label id="categorylabel">Category: All</label><br>
        <select id="categoryFilter">
            <option value="All">All Categories</option>
            <option value="Historic Buildings & Sites">Historic Buildings & Sites</option>
            <option value="Museums & Galleries">Museums & Galleries</option>
            <option value="Natural & Outdoor Attractions">Natural & Outdoor</option>
            <option value="Transport & Industrial Heritage">Transport & Industrial</option>
            <option value="Industrial & Craft Experiences">Industrial & Craft</option>
            <option value="Modern Entertainment & Technology">Modern Entertainment</option>
            <option value="Other & Miscellaneous">Other</option>
        </select>
        
        <!-- 图例 -->
        <div id="legend">
            <h3> Attraction Categories</h3>
            <div id="legend-content"></div>
        </div>
    </div>

    <!-- 底部游客数量面板 -->
    <div id="regionalChartPanel">
        <h4> Top Attractions（Visitors by Year）</h4>
        <label for="yearSlider"><strong>Year:</strong><span id="yearLabel">2023</span></label>
        <input type="range" id="yearSlider" min="2018" max="2023" value="2023" step="1" />
        <div id="chartContainer">
            <canvas id="regionalChart"></canvas>
        </div>
    </div>
<!--
    <div id="regionalChartPanel" style="position: absolute; bottom: 400px; left: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); width: 500px;">
    <h4>Top 10 Attractions in Selected Region (2023 Visitors)</h4>
    <div style="height: 300px;">
        <canvas id="regionalChart"></canvas>
    </div>
</div>
-->

    <script>
        
        
//        1. 常量和变量定义&初始化地图和图层（Mapbox）
        
        // 初始化地图配置
        mapboxgl.accessToken = 'pk.eyJ1Ijoia3VuZGk3Nzg4IiwiYSI6ImNtNmkzejF2cjAzaXQyaXM5a290bWZlb3YifQ.m5Puy892HwG64qMAoEd7sA';
        
        // 创建地图实例
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/kundi7788/cm7sjozi3006a01sc42097gk7',
            center: [-4, 53],  // 初始中心点坐标
            zoom: 5.8          // 初始缩放级别
        });
        
        // 颜色映射
        const colorMapping = {
            'Historic Buildings & Sites': '#8466C6',
            'Museums & Galleries': '#FFD700',
            'Natural & Outdoor Attractions': '#F29B7A',
            'Transport & Industrial Heritage': '#E06AC7',
            'Industrial & Craft Experiences': '#66D1C3',
            'Modern Entertainment & Technology': '#A8D8EA',
            'Other & Miscellaneous': '#B0B9B2'
        };

         // 初始化图例
            const legendContent = document.getElementById('legend-content');
            Object.entries(colorMapping).forEach(([category, color]) => {
                const legendItem = document.createElement('div');
                legendItem.classList.add('legend-item');
                legendItem.innerHTML = `
                    <div class="legend-color-box" style="background-color: ${color};"></div>
                    <span>${category}</span>
                `;
                legendContent.appendChild(legendItem);
            });

        let fullMapBounds = null;
        let allAttractions = [];
        let hoveredPointId = null;
        let hoverPopup = null;
        
        
// ===================== 新增代码部分 =====================
let regionalChart = null;

// ===================== 2. 加载地图与数据 =====================
map.on('load', () => {
  // 添加 GeoJSON 数据源
  map.addSource('attractions', {
    type: 'geojson',
    data: 'data/attractions_filtered.geojson',
    generateId: true // 支持 feature state 操作
  });
    
////      添加区域数据源
//            map.addSource('regions', {
//                type: 'geojson',
//                data: 'data/boundaries.geojson' // 替换为你的数据路径
//            });
//            
//            // 添加边界线图层
//            map.addLayer({
//                id: 'regions-layer-border',
//                type: 'line',
//                source: 'regions',
//                paint: {
//                    'line-color': '#999999',  // 设置边界颜色
//                    'line-width': 0.5,// 设置边界线的宽度
//                     'line-opacity': 0.5  // 设置边界线的透明度
//                }
//            });

  // 添加图层显示景点
  map.addLayer({
    id: 'attractions-layer',
    type: 'circle',
    source: 'attractions',
    paint: {
      'circle-radius': [
    'case',
    ['!', ['has', 'Visitors 2023']], 3,  // 如果没有Visitors 2023字段，则默认半径为3
    ['<', ['to-number', ['get', 'Visitors 2023']], 1000], 2,  // 如果游客数量小于1000，则半径为5
    ['<', ['to-number', ['get', 'Visitors 2023']], 10000], 3,  // 如果游客数量小于10000，则半径为9
    ['<', ['to-number', ['get', 'Visitors 2023']], 50000], 4,  // 如果游客数量小于50000，则半径为12
    ['<', ['to-number', ['get', 'Visitors 2023']], 100000], 8,  // 如果游客数量小于100000，则半径为15
    ['<', ['to-number', ['get', 'Visitors 2023']], 500000], 12,  // 如果游客数量小于500000，则半径为18
    ['<', ['to-number', ['get', 'Visitors 2023']], 1000000], 15,  // 如果游客数量小于500000，则半径为18
    ['<', ['to-number', ['get', 'Visitors 2023']], 1500000], 20,  // 如果游客数量小于500000，
    ['<', ['to-number', ['get', 'Visitors 2023']], 2000000], 25,  // 如果游客数量小于500000，
    ['>=', ['to-number', ['get', 'Visitors 2023']], 4000000], 30,  // 如果游客数量大于5000000，则半径为20
    2  // 默认半径为4
],
//                   
                    'circle-opacity': 0.7,
                    'circle-color': [
                        'match',
                        ['get', 'Main_Category'],
                        ...Object.entries(colorMapping).flat(),
                        '#cccccc'  // 默认颜色
                    ]
    }
  });

        // 记录完整地图边界，用于后续 reset 缩放
        map.once('idle', () => {
          fullMapBounds = map.getBounds();
        });

        // 异步加载数据用于过滤逻辑（非图层部分）
        fetch('data/attractions_filtered.geojson')
          .then(res => res.json())
          .then(data => {
            allAttractions = data.features;
            // 添加延迟确保DOM就绪（仅用于调试）
          setTimeout(() => {
            updateRegionalChart('All');
            initApp();
          }, 100);
          });
          
          // 新增：初始化时渲染全国数据
            updateRegionalChart('All'); 

        // 启动初始交互逻辑（图例/按钮/筛选等）
        initApp();
      });

// ===================== 3. 设置筛选功能 =====================
function setupEventListeners() {
  document.getElementById('regionfilter').addEventListener('change', applyFilters);
  document.getElementById('categoryFilter').addEventListener('change', applyFilters);
}

// 筛选逻辑
function applyFilters() {
  const selectedRegion = document.getElementById('regionfilter').value;
  const selectedCategory = document.getElementById('categoryFilter').value;

  // 更新标签文字
  document.getElementById('regionlabel').textContent = 'Region: ' + selectedRegion;
  document.getElementById('categorylabel').textContent = 'Category: ' + selectedCategory;

  // 构造过滤器数组
  let filters = [];
  if (selectedRegion !== 'All') {
    filters.push(['==', ['get', 'Region'], selectedRegion]);
  }
  if (selectedCategory !== 'All') {
    filters.push(['==', ['get', 'Main_Category'], selectedCategory]);
  }

  // 应用过滤器到地图图层
  let finalFilter = null;
  if (filters.length === 1) {
    finalFilter = filters[0];
  } else if (filters.length > 1) {
    finalFilter = ['all', ...filters];
  }
  console.log("Applied Filter:", finalFilter);
  map.setFilter('attractions-layer', finalFilter);


  // test 
   // 视图自动缩放至所选区域
   if (selectedRegion !== 'All') {
    // 检查数据源状态
    if (!map.getSource('attractions')) {
      console.error('数据源未初始化');
      return;
    }
    if (!map.isSourceLoaded('attractions')) {
      console.error('数据尚未加载完成');
      return;
    }

    // 查询全量数据
    const features = map.querySourceFeatures('attractions', {
      filter: ['==', ['get', 'Region'], selectedRegion],
      validate: false // 关键修改
    });

    console.log(`[DEBUG] 区域 ${selectedRegion} 查询到要素数量:`, features.length);

    if (features.length > 0) {
      const bounds = new mapboxgl.LngLatBounds();
      features.forEach(f => {
        if (f.geometry?.coordinates) {
          bounds.extend(f.geometry.coordinates);
        }
      });
      
      if (!bounds.isEmpty()) {
        map.fitBounds(bounds, { 
          padding: 40, 
          maxZoom: 9,
          duration: 1000 // 添加平滑过渡
        });
      } else {
        console.warn('边界计算失败：无有效坐标');
      }
    } else {
      console.warn('该区域无数据');
      // 可选：重置视图或显示提示
      map.fitBounds(fullMapBounds, { padding: 40 });
    }
  } else {
    map.fitBounds(fullMapBounds, { padding: 40 });
  }

  // 更新区域图表
  updateRegionalChart(selectedRegion);
}
  // // 视图自动缩放至所选区域
  // if (selectedRegion !== 'All') {

     
  //   const features = map.querySourceFeatures('attractions', {
  //     filter: ['==', ['get', 'Region'], selectedRegion],
  //     validate: false // 强制查询全量数据
  //   });

  //   if (features.length > 0) {
  //     const bounds = new mapboxgl.LngLatBounds();
  //     features.forEach(f => bounds.extend(f.geometry.coordinates));
  //     map.fitBounds(bounds, { padding: 40, maxZoom: 9 });
  //   }
  // } else {
  //   map.fitBounds(fullMapBounds, { padding: 40 });
  // }
    
  //    // 新增：更新区域图表
  //   updateRegionalChart(selectedRegion);
// }

// ===================== 4. 悬停与弹窗 =====================
function handleFeatureHover(e) {
  if (e.features.length > 0) {
    // 取消之前的高亮状态
    if (hoveredPointId !== null) {
      map.setFeatureState(
        { source: 'attractions', id: hoveredPointId },
        { hover: false }
      );
    }

    // 设置当前要素高亮状态
    hoveredPointId = e.features[0].id;
    map.setFeatureState(
      { source: 'attractions', id: hoveredPointId },
      { hover: true }
    );

    // 移除旧的弹窗
    if (hoverPopup) {
      hoverPopup.remove();
      hoverPopup = null;
    }

    // 创建新弹窗
    const feature = e.features[0];
    hoverPopup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false })
      .setLngLat(e.lngLat)
      // .setHTML(`<strong>${feature.properties.Name}</strong><br>${feature.properties.Main_Category}`)
      .setHTML(`
      <div style="font-size: 12px">
        <strong>${feature.properties.Attraction || "Unknown"}</strong><br>
        Category: ${feature.properties.Main_Category || "N/A"}<br>
        Visitors: ${
          feature.properties["Visitors 2023"]
            ? Number(feature.properties["Visitors 2023"]).toLocaleString()
            : "N/A"
        }
      </div>
    `)
      .addTo(map);
  }
}

// ===================== 5. 启动函数入口 =====================
function initApp() {
  setupEventListeners();

  // 添加悬停事件
  map.on('mousemove', 'attractions-layer', handleFeatureHover);
  map.on('mouseleave', 'attractions-layer', () => {
    if (hoveredPointId !== null) {
      map.setFeatureState(
        { source: 'attractions', id: hoveredPointId },
        { hover: false }
      );
    }
    hoveredPointId = null;

    if (hoverPopup) {
      hoverPopup.remove();
      hoverPopup = null;
    }
  });
}

     
        // ===================== 修改后的代码 =====================
// 创建或更新区域柱状图（增强版）
function updateRegionalChart(region) {
    // 获取当前区域数据
    const features = region === 'All' ? 
        allAttractions : 
        map.querySourceFeatures('attractions', {
            filter: ['==', ['get', 'Region'], region],
            validate: false // 关键修改
        });

    // 数据去重处理（使用Map保证唯一性）
    const attractionMap = new Map();
    
    features.forEach(f => {
        // 获取规范化名称和游客数
        const rawName = f.properties.Attraction || f.properties.Name;
        const name = normalizeName(rawName) || "Unnamed Attraction";
        const visitors = parseVisitors(f.properties['Visitors 2023']);
        
        // 有效数据处理
        if (visitors !== null) {
            // 保留游客量最大的记录
            if (!attractionMap.has(name) || attractionMap.get(name).visitors < visitors) {
                attractionMap.set(name, {
                    displayName: rawName || "Unnamed Attraction", // 保留原始显示名称
                    visitors: visitors
                });
            }
        }
    });

    // 生成处理后的数据
    const processedData = Array.from(attractionMap.values())
        .sort((a, b) => b.visitors - a.visitors)
        .slice(0, 10);

    // 销毁旧图表
    const ctx = document.getElementById('regionalChart').getContext('2d');
    if (regionalChart) {
        regionalChart.destroy();
    }

    // 创建新图表（优化版）
    regionalChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: processedData.map(d => truncateLabel(d.displayName, 25)),
            datasets: [{
                label: 'Visitors (2023)',
                data: processedData.map(d => d.visitors),
                backgroundColor: '#00B8A9',
                borderColor: '#007B73',
                borderWidth: 1,
                barThickness: 12,
                borderRadius: 4 // 添加圆角
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Visitor Count',
                        padding: 10
                    },
                    ticks: {
                        callback: value => value.toLocaleString()
                    }
                },
                y: {
                    ticks: {
                        autoSkip: false,
                        font: {
                            size: 12
                        },
                        padding: 8
                    }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleFont: { size: 14 },
                    bodyFont: { size: 12 },
                    callbacks: {
                        title: context => processedData[context[0].dataIndex].displayName,
                        label: context => `${context.parsed.x.toLocaleString()} visitors`
                    }
                }
            }
        }
    });
}

// 辅助函数：名称规范化
function normalizeName(name) {
    if (!name) return null;
    return name
        .toString()
        .trim()
        .toLowerCase()
        .replace(/\s+/g, ' ')   // 合并多余空格
        .replace(/[^\w\s]/g, '') // 移除特殊符号
        .replace(/\b(the|a|an)\b/gi, ''); // 移除冠词
}

/// 辅助函数：精确解析游客数量（修复小数点问题）
function parseVisitors(value) {
    if (!value) return null;

    // 处理特殊字符串
    const strValue = value.toString().trim();
    if (/closed|not available/i.test(strValue)) return null;

    // 保留数字和小数点
    const numericString = strValue
        .replace(/,/g, '')       // 移除千分位逗号
        .replace(/[^0-9.]/g, ''); // 保留数字和小数点

    // 处理无效格式（如多个小数点）
    if ((numericString.match(/\./g) || []).length > 1) return null;

    // 转换为浮点数并四舍五入
    const num = parseFloat(numericString);
    return isNaN(num) ? null : Math.round(num);
}

// 辅助函数：智能标签截断
function truncateLabel(str, maxLength) {
    if (!str) return '';
    str = str.toString().trim();
    
    // 优先在空格处截断
    const lastSpaceIndex = str.lastIndexOf(' ', maxLength);
    if (lastSpaceIndex > maxLength * 0.7) {
        return str.substring(0, lastSpaceIndex) + "...";
    }
    return str.length > maxLength ? 
        str.substring(0, maxLength) + "..." : 
        str;
}
    </script>
</body>
</html>